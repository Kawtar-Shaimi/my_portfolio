name: Deploy to PythonAnywhere

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to PythonAnywhere
      env:
        PA_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
        PA_TOKEN: ${{ secrets.PYTHONANYWHERE_TOKEN }}
      run: |
        # Pull latest code from repository
        curl -X POST \
          "https://www.pythonanywhere.com/api/v0/user/${PA_USERNAME}/consoles/" \
          -H "Authorization: Token ${PA_TOKEN}" \
          -H "Content-Type: application/json" \
          -d '{
            "executable": "bash",
            "arguments": ["-c", "cd /home/shaimi/my_portfolio && git pull"]
          }'
        
        sleep 5
        
        # Install/Update dependencies
        curl -X POST \
          "https://www.pythonanywhere.com/api/v0/user/${PA_USERNAME}/consoles/" \
          -H "Authorization: Token ${PA_TOKEN}" \
          -H "Content-Type: application/json" \
          -d '{
            "executable": "bash",
            "arguments": ["-c", "cd /home/shaimi/my_portfolio && source /home/shaimi/my_portfolio/venv/bin/activate && pip install -r requirements.txt"]
          }'
        
        sleep 5
        
        # Run Django migrations
        curl -X POST \
          "https://www.pythonanywhere.com/api/v0/user/${PA_USERNAME}/consoles/" \
          -H "Authorization: Token ${PA_TOKEN}" \
          -H "Content-Type: application/json" \
          -d '{
            "executable": "bash",
            "arguments": ["-c", "cd /home/shaimi/my_portfolio && source /home/shaimi/my_portfolio/venv/bin/activate && python manage.py migrate --noinput"]
          }'
        
        sleep 5
        
        # Collect static files
        curl -X POST \
          "https://www.pythonanywhere.com/api/v0/user/${PA_USERNAME}/consoles/" \
          -H "Authorization: Token ${PA_TOKEN}" \
          -H "Content-Type: application/json" \
          -d '{
            "executable": "bash",
            "arguments": ["-c", "cd /home/shaimi/my_portfolio/venv/bin/activate && python manage.py collectstatic --noinput"]
          }'
        
        sleep 5
        
        # Reload web app
        curl -X POST \
          "https://www.pythonanywhere.com/api/v0/user/${PA_USERNAME}/webapps/shaimi.pythonanywhere.com/reload/" \
          -H "Authorization: Token ${PA_TOKEN}"
    
    - name: Deployment Status
      run: echo "Deployment to PythonAnywhere completed!"